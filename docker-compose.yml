services:
  # Ollama LLM service
  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    restart: unless-stopped

  # Stable Diffusion WebUI service
  stable-diffusion:
    image: universonic/stable-diffusion-webui:latest
    volumes:
      - ./models:/app/stable-diffusion-webui/models
      - ./outputs:/app/stable-diffusion-webui/outputs
    ports:
      - "7860:7860"
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # Remove the deploy section above if you don't have an NVIDIA GPU
    # The service will fall back to CPU mode

  # SparklAI application
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      # Database configuration
      DATABASE_URL: file:/data/local.db
      
      # Chat/LLM configuration - using ollama service
      CHAT_URL: http://ollama:11434/v1/
      CHAT_MODEL: llama3.1:8b
      
      # Stable Diffusion configuration - using stable-diffusion service
      SD_URL: http://stable-diffusion:7860/sdapi/v1/
      
      # Photo model settings
      SD_PHOTO_MODEL: dreamshaper_8_93211
      SD_PHOTO_PROMPT: "RAW photo,8k uhd,dslr,high quality"
      SD_PHOTO_NEGATIVE_PROMPT: "nsfw,underexposed,underexposure,overexposure,overexposed,canvas frame,cartoon,3d,3d render,CGI,computer graphics"
      
      # Drawing model settings
      SD_DRAWING_MODEL: rabbit_v7
      SD_DRAWING_PROMPT: "masterpiece,best quality,absurdres,highres"
      SD_DRAWING_NEGATIVE_PROMPT: "3d,3d render,CGI,computer graphics"
      
      # Stylized model settings
      SD_STYLIZED_MODEL: restlessexistence_v30Reflection
      SD_STYLIZED_PROMPT: "(Maya 3d render:1.05),(masterpiece:1.3),(hires,high resolution:1.3),subsurface scattering,ambient occlusion,bloom"
      SD_STYLIZED_NEGATIVE_PROMPT: "underexposed,underexposure,overexposure,overexposed,canvas frame,cartoon"
    volumes:
      # Persist the SQLite database
      - sparklai-data:/data
    restart: unless-stopped
    depends_on:
      - ollama
      - stable-diffusion

volumes:
  sparklai-data:
  ollama-data:
